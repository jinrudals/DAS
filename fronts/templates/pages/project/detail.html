{% extends "layouts/base.html" %}
{% load static %}
{% load django_bootstrap5 %}
{% load utils %}
{% block title %}{{ project.name }}{% endblock %}
{% block content %}
    <!-- Real-time updates data attributes -->
    <div id="project-context" data-project-name="{{ project.name }}" style="display: none;"></div>
    
    <!-- Breadcrumb Navigation -->
    {% with breadcrumb_items=breadcrumb_items %}
        {% if not breadcrumb_items %}
            {% with breadcrumb_items=default_breadcrumbs %}
                {% include 'components/breadcrumb.html' %}
            {% endwith %}
        {% else %}
            {% include 'components/breadcrumb.html' %}
        {% endif %}
    {% endwith %}
    
    <div class="container-fluid my-4">
        <h2 class="mb-4">{{ project.name }}</h2>
        <!-- Filter Form Component -->
        {% include 'components/project_filters.html' with view_type=view_type available_branches=available_branches selected_branch=selected_branch selected_date=selected_date %}
        {% if request.user.is_authenticated %}
            <div id="jenkins-action-bar" class="mb-3">
                <button id="to-jenkins" class="btn btn-outline-primary">To Jenkins</button>
                <div id="jenkins-controls" class="d-inline ms-3">
                    {% if view_type == "IP" %}
                        <label>branch</label>
                        <input id="branch-input" value="STABLE" disabled>
                    {% elif view_type == "HPDF" or view_type == "DFTed" %}
                        <label>branch</label>
                        <input id="branch-input" value="{{ selected_branch }}">
                    {% endif %}
                    <button id="jenkins-submit" class="btn btn-success me-2">Submit</button>
                    <button id="jenkins-cancel" class="btn btn-danger">Cancel</button>
                </div>
            </div>
        {% endif %}
        <!-- Group Filter Tabs -->
        <ul class="nav nav-pills mb-3" id="groupTabs" role="tablist">
            <!-- All criteria tab -->
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-tab" data-bs-toggle="pill" data-bs-target="#all-criteria" type="button" role="tab">
                    All ({{ criteria|length }})
                </button>
            </li>
            <!-- Group tabs -->
            {% for group_data in grouped_criteria %}
                {% if group_data.group %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="group-{{ group_data.group.id }}-tab" 
                                data-bs-toggle="pill" 
                                data-bs-target="#group-{{ group_data.group.id }}" 
                                type="button" role="tab"
                                {% if group_data.group.color %}style="border-color: {{ group_data.group.color }};"{% endif %}>
                            {{ group_data.group.name }} ({{ group_data.count }})
                        </button>
                    </li>
                {% endif %}
            {% endfor %}
            <!-- Ungrouped criteria tab -->
            {% for group_data in grouped_criteria %}
                {% if not group_data.group %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ungrouped-tab" data-bs-toggle="pill" data-bs-target="#ungrouped-criteria" type="button" role="tab">
                            Ungrouped ({{ group_data.count }})
                        </button>
                    </li>
                {% endif %}
            {% endfor %}
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="groupTabContent">
            <!-- All criteria tab -->
            <div class="tab-pane fade show active" id="all-criteria" role="tabpanel" aria-labelledby="all-tab">
                {% include 'components/execution_table.html' with criteria=criteria targets=targets execution_map=execution_map show_filter=False table_id="all-criteria-table" %}
            </div>
            
            <!-- Individual group tabs -->
            {% for group_data in grouped_criteria %}
                {% if group_data.group %}
                    <div class="tab-pane fade" 
                         id="group-{{ group_data.group.id }}" 
                         role="tabpanel" 
                         aria-labelledby="group-{{ group_data.group.id }}-tab">
                        {% include 'components/execution_table.html' with criteria=group_data.criteria targets=targets execution_map=execution_map show_filter=True table_id="group-"|add:group_data.group.id|add:"-table" %}
                    </div>
                {% endif %}
            {% endfor %}

            <!-- Ungrouped criteria tab -->
            {% for group_data in grouped_criteria %}
                {% if not group_data.group %}
                    <div class="tab-pane fade" 
                         id="ungrouped-criteria" 
                         role="tabpanel" 
                         aria-labelledby="ungrouped-tab">
                        {% include 'components/execution_table.html' with criteria=group_data.criteria targets=targets execution_map=execution_map show_filter=True table_id="ungrouped-table" %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    <!-- Modern Execution Detail Modal -->
    {% include "components/execution_detail_modal.html" %}
{% endblock %}
{% block custom_css %}
    <!-- Component CSS -->
    <link rel="stylesheet" href="{% static 'css/components/badges.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/forms.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/tables.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/modals.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/column-filters.css' %}">
    <!-- Real-time updates CSS -->
    <link rel="stylesheet" href="{% static 'css/realtime-updates.css' %}">
    <!-- Page-specific CSS -->
    <link rel="stylesheet" href="{% static 'css/page/project/detail.css' %}">
{% endblock %}
{% block custom_js %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
    <!-- Component JavaScript Classes -->
    <script src="{% static 'js/components/ExecutionDetailModal.js' %}"></script>
    <script src="{% static 'js/components/TableSorter.js' %}"></script>
    <script src="{% static 'js/components/JenkinsMode.js' %}"></script>
    <script src="{% static 'js/components/TableColumnFilter.js' %}"></script>
    <!-- Real-time WebSocket Components -->
    <script src="{% static 'js/components/WebSocketManager.js' %}"></script>
    <script src="{% static 'js/components/ToastNotificationManager.js' %}"></script>
    <!-- Page JavaScript -->
    <script src="{% static 'js/page/project/detail.js' %}"></script>
{% endblock %}
